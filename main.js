const i18n = {
    en: {
        documentTitle: 'Find Your ILJU Animal',
        title: 'Find Your ILJU Animal',
        description: 'Enter your birth date to see your ILJU animal and its elemental energy.',
        brandName: 'Animal Energy',
        brandTagline: 'Global ILJU Insight Studio',
        navOverview: 'Overview',
        navInsights: 'Insights',
        navPlans: 'Plans',
        navSupport: 'Support',
        loginButton: 'Log in',
        signupButton: 'Create account',
        heroEyebrow: 'Professional ILJU Service',
        heroPrimary: 'Get my reading',
        heroSecondary: 'View plans',
        trustItem1: 'Used in 20+ countries',
        trustItem2: 'Personal dashboard ready',
        trustItem3: 'Private & secure profile',
        cardTitle: 'Start your personal reading',
        cardSubtitle: 'We combine day pillar analysis with five-element balance to deliver a clear, professional summary.',
        servicesEyebrow: 'What you get',
        servicesTitle: 'A guided, professional experience',
        servicesSubtitle: 'Structured insights designed for international users who want clarity, not confusion.',
        serviceOneTitle: 'Daily pillar overview',
        serviceOneText: 'Instantly see your ILJU animal, element, and keyword themes in a calm, structured format.',
        serviceTwoTitle: 'Personal trend dashboard',
        serviceTwoText: 'Save multiple profiles, compare dates, and track changes over time once you sign in.',
        serviceThreeTitle: 'Expert-ready reports',
        serviceThreeText: 'Exportable summaries built for consultations, life planning, and decision support.',
        plansEyebrow: 'Membership',
        plansTitle: 'Plans built for global users',
        plansSubtitle: 'Choose the experience that fits your depth of exploration.',
        planStarterTitle: 'Starter',
        planStarterText: 'One-time reading with key themes and summary.',
        planStarterPrice: '$9',
        planStarterCta: 'Choose Starter',
        planProTitle: 'Pro',
        planProText: 'Unlimited readings, profile history, and exportable reports.',
        planProPrice: '$19 / month',
        planProCta: 'Choose Pro',
        planPlusTitle: 'Plus',
        planPlusText: 'Includes consultation-ready insights and priority support.',
        planPlusPrice: '$39 / month',
        planPlusCta: 'Choose Plus',
        supportEyebrow: 'Support',
        supportTitle: 'Guided by clarity',
        supportSubtitle: 'We support international users with transparent guidance and contextual explanations.',
        supportOneTitle: 'Multilingual summaries',
        supportOneText: 'Language-tuned outputs help you share results with family, friends, or advisors.',
        supportTwoTitle: 'Private profiles',
        supportTwoText: 'Sign in to keep your readings secure and organized across devices.',
        footerBrand: 'Animal Energy',
        footerTagline: 'Global ILJU Insight Studio',
        footerText: 'A professional, global-first interpretation of ILJU symbols for modern decision-making.',
        footerLinkOverview: 'Overview',
        footerLinkInsights: 'Insights',
        footerLinkPlans: 'Plans',
        footerLinkSupport: 'Support',
        langLabel: 'Language',
        languageNames: {
            en: 'English',
            ja: 'Japanese',
            ko: 'Korean'
        },
        labelYear: 'Year',
        labelMonth: 'Month',
        labelDay: 'Day',
        labelTime: 'Time (optional)',
        placeholderYear: 'e.g., 1990',
        placeholderMonth: 'e.g., 7',
        placeholderDay: 'e.g., 14',
        placeholderTime: 'HH:MM',
        checkButton: 'Check',
        detailButton: 'Learn more',
        resultTitle: 'Your ILJU animal',
        resultAnimalLabel: 'Animal',
        resultElementLabel: 'Element',
        resultKeywordsLabel: 'Keywords',
        resultSummaryTemplate: 'Base nature: {animalTrait}. Relationships: {relationTip}. Work/study: {workTip}. Money: {moneyTip}. Life phases — Early: {earlyLife}. Mid: {midLife}. Later: {lateLife}.',
        resetButton: 'Try another date',
        invalidDate: 'Please enter a valid date.',
        invalidYear: 'Year must be between 1900 and {maxYear}.',
        invalidMonth: 'Month must be between 1 and 12.',
        invalidDay: 'Please enter a valid day for the selected month and year.',
        animalSentence: 'Your ILJU animal is {animal}.',
        elementSentence: '{color} {animal}, with {element} energy.',
        elementNames: {
            Wood: 'Wood',
            Fire: 'Fire',
            Earth: 'Earth',
            Metal: 'Metal',
            Water: 'Water'
        },
        elementKeywords: {
            Wood: 'growth · kindness · steady',
            Fire: 'passion · confidence · spark',
            Earth: 'balance · reliability · care',
            Metal: 'clarity · focus · discipline',
            Water: 'intuition · depth · flow'
        },
        animalTraits: {
            Rat: 'quick-witted and resourceful',
            Ox: 'steady and dependable',
            Tiger: 'bold and self-driven',
            Rabbit: 'thoughtful and diplomatic',
            Dragon: 'confident and magnetic',
            Snake: 'strategic and intuitive',
            Horse: 'energetic and freedom-loving',
            Goat: 'warm and creative',
            Monkey: 'clever and adaptable',
            Rooster: 'direct and organized',
            Dog: 'loyal and fair-minded',
            Pig: 'kind and generous'
        },
        elementAdvice: {
            Wood: {
                relation: 'lead with patience and let warmth grow',
                work: 'build steady progress instead of big jumps',
                money: 'invest in skills and long-term plans'
            },
            Fire: {
                relation: 'express yourself clearly to open the flow',
                work: 'move fast, but avoid overcommitment',
                money: 'watch impulse spending'
            },
            Earth: {
                relation: 'listening and steadiness build trust',
                work: 'stay consistent and follow through',
                money: 'budgeting brings calm gains'
            },
            Metal: {
                relation: 'clear boundaries improve harmony',
                work: 'prioritize precision and structure',
                money: 'cut leaks and simplify'
            },
            Water: {
                relation: 'give space and observe before acting',
                work: 'deep focus on one task pays off',
                money: 'keep a flexible cushion'
            }
        },
        elementLife: {
            Wood: {
                early: 'a curious start with steady growth and skill-building',
                mid: 'expansion through consistent routines and collaborations',
                late: 'stability from long-term investments and mentoring'
            },
            Fire: {
                early: 'strong momentum and bold choices',
                mid: 'visibility and leadership, with a need to manage pace',
                late: 'creative influence and selective commitments'
            },
            Earth: {
                early: 'a grounded base built through responsibility',
                mid: 'reliable progress and steady recognition',
                late: 'security from patience and careful planning'
            },
            Metal: {
                early: 'clear standards and fast learning through structure',
                mid: 'refined expertise and reputation for precision',
                late: 'focused legacy built on discipline'
            },
            Water: {
                early: 'deep observation and adaptable learning',
                mid: 'strategic shifts and resilient growth',
                late: 'calm stability and wisdom sharing'
            }
        },
        elementLifeLabels: {
            Wood: 'growth and steady expansion',
            Fire: 'momentum and visibility',
            Earth: 'stability and responsibility',
            Metal: 'structure and refinement',
            Water: 'adaptability and depth'
        },
        colorWords: {
            Wood: 'Blue-Green',
            Fire: 'Red',
            Earth: 'Yellow',
            Metal: 'White',
            Water: 'Black'
        },
        animals: ['Rat', 'Ox', 'Tiger', 'Rabbit', 'Dragon', 'Snake', 'Horse', 'Goat', 'Monkey', 'Rooster', 'Dog', 'Pig'],
        stems: ['Jia', 'Yi', 'Bing', 'Ding', 'Wu', 'Ji', 'Geng', 'Xin', 'Ren', 'Gui'],
        stemElements: ['Wood', 'Wood', 'Fire', 'Fire', 'Earth', 'Earth', 'Metal', 'Metal', 'Water', 'Water']
    },
    ja: {
        documentTitle: '十二支を確認',
        title: 'あなたの十二支を確認しましょう',
        description: '生年月日を入力すると、あなたの十二支と気の属性がわかります。',
        brandName: 'Animal Energy',
        brandTagline: 'グローバル日柱スタジオ',
        navOverview: '概要',
        navInsights: 'インサイト',
        navPlans: 'プラン',
        navSupport: 'サポート',
        loginButton: 'ログイン',
        signupButton: '会員登録',
        heroEyebrow: 'プロフェッショナル日柱サービス',
        heroPrimary: '診断を始める',
        heroSecondary: 'プランを見る',
        trustItem1: '20か国以上で利用',
        trustItem2: '個人ダッシュボード対応',
        trustItem3: 'プライバシー保護',
        cardTitle: 'パーソナル診断を開始',
        cardSubtitle: '日柱分析と五行バランスを組み合わせ、整理された結果を提供します。',
        servicesEyebrow: '提供内容',
        servicesTitle: 'わかりやすいプロ体験',
        servicesSubtitle: '海外ユーザー向けに整理された、明快なインサイトを届けます。',
        serviceOneTitle: '日柱の概要',
        serviceOneText: '十二支・五行・キーワードをすぐに確認できます。',
        serviceTwoTitle: 'パーソナルダッシュボード',
        serviceTwoText: 'ログイン後は複数プロフィールを保存して比較できます。',
        serviceThreeTitle: 'レポート出力',
        serviceThreeText: '相談や計画に活用できる要約レポートを作成します。',
        plansEyebrow: 'メンバーシップ',
        plansTitle: 'グローバルユーザー向けプラン',
        plansSubtitle: '深さに合わせて選べるシンプルな構成。',
        planStarterTitle: 'スターター',
        planStarterText: '1回の診断と要約。',
        planStarterPrice: '$9',
        planStarterCta: 'スターターを選ぶ',
        planProTitle: 'プロ',
        planProText: '無制限の診断と履歴、レポート出力。',
        planProPrice: '$19 / 月',
        planProCta: 'プロを選ぶ',
        planPlusTitle: 'プラス',
        planPlusText: '相談向けインサイトと優先サポート。',
        planPlusPrice: '$39 / 月',
        planPlusCta: 'プラスを選ぶ',
        supportEyebrow: 'サポート',
        supportTitle: '明確さを重視',
        supportSubtitle: '国際ユーザー向けの丁寧な説明とガイド。',
        supportOneTitle: '多言語サマリー',
        supportOneText: '家族やパートナーに共有しやすい表現。',
        supportTwoTitle: 'プライベート管理',
        supportTwoText: 'ログインして結果を安全に保存できます。',
        footerBrand: 'Animal Energy',
        footerTagline: 'グローバル日柱スタジオ',
        footerText: '現代の意思決定に寄り添う、国際対応のILJU解析。',
        footerLinkOverview: '概要',
        footerLinkInsights: 'インサイト',
        footerLinkPlans: 'プラン',
        footerLinkSupport: 'サポート',
        langLabel: '言語',
        languageNames: {
            en: '英語',
            ja: '日本語',
            ko: '韓国語'
        },
        labelYear: '年',
        labelMonth: '月',
        labelDay: '日',
        labelTime: '出生時間（任意）',
        placeholderYear: '例: 1990',
        placeholderMonth: '例: 7',
        placeholderDay: '例: 14',
        placeholderTime: '時:分',
        checkButton: '確認する',
        detailButton: 'もっと詳しく',
        resultTitle: 'あなたの十二支',
        resultAnimalLabel: '動物',
        resultElementLabel: '気',
        resultKeywordsLabel: 'キーワード',
        resultSummaryTemplate: '本質: {animalTrait}。人間関係: {relationTip}。仕事・学び: {workTip}。金運: {moneyTip}。人生の流れ — 初年: {earlyLife}。中年: {midLife}。晩年: {lateLife}。',
        resetButton: '別の日付を試す',
        invalidDate: '正しい日付を入力してください。',
        invalidYear: '年は1900〜{maxYear}の範囲で入力してください。',
        invalidMonth: '月は1〜12の範囲で入力してください。',
        invalidDay: '選択した年月に合う日付を入力してください。',
        animalSentence: 'あなたの十二支は{animal}です。',
        elementSentence: '{color}の{animal}、{element}の気を持つ動物です。',
        elementNames: {
            Wood: '木',
            Fire: '火',
            Earth: '土',
            Metal: '金',
            Water: '水'
        },
        elementKeywords: {
            Wood: '成長・柔軟・温かさ',
            Fire: '情熱・表現・勢い',
            Earth: '安定・安心・包容',
            Metal: '明晰・規律・芯の強さ',
            Water: '直感・深み・適応'
        },
        animalTraits: {
            鼠: '機転が利き、情報収集が得意',
            牛: '粘り強く、信頼されやすい',
            虎: '行動力があり、芯が強い',
            兎: '穏やかで調整役が上手',
            龍: '存在感があり、挑戦的',
            蛇: '直感的で、計画性がある',
            馬: 'エネルギッシュで自由志向',
            羊: '温かく、感性が豊か',
            猿: '柔軟で発想力がある',
            鶏: '率直で整理が得意',
            犬: '誠実で守りが堅い',
            猪: '寛大で人当たりが良い'
        },
        elementAdvice: {
            Wood: {
                relation: 'ゆっくり信頼を育てると良い',
                work: '段階的に積み上げる',
                money: '長期の備えが吉'
            },
            Fire: {
                relation: '気持ちを言葉にすると流れが良い',
                work: 'スピード感を活かすが無理は禁物',
                money: '衝動買いに注意'
            },
            Earth: {
                relation: '安心感を与える態度が鍵',
                work: '継続力を意識',
                money: '計画的な管理で安定'
            },
            Metal: {
                relation: '境界線を明確にすると楽',
                work: '精度と整理で成果',
                money: '無駄を削ると伸びる'
            },
            Water: {
                relation: '距離感を調整して観察',
                work: '一点集中で深掘り',
                money: '余裕資金を確保'
            }
        },
        elementLife: {
            Wood: {
                early: '好奇心が強く、基礎づくりが進む',
                mid: '積み上げ型で広がりが出る',
                late: '長期の備えが安定につながる'
            },
            Fire: {
                early: '勢いがあり、挑戦が多い',
                mid: '注目や役割が増えやすい',
                late: '創造性を活かして選択が洗練される'
            },
            Earth: {
                early: '責任を引き受けて土台を作る',
                mid: '堅実に評価が積み上がる',
                late: '忍耐の積み重ねが安心を生む'
            },
            Metal: {
                early: '基準が明確で伸びやすい',
                mid: '専門性が磨かれ信頼が高まる',
                late: '規律が落ち着いた強みになる'
            },
            Water: {
                early: '観察力で柔軟に学ぶ',
                mid: '戦略的な転換が活きる',
                late: '穏やかな安定と知恵の共有'
            }
        },
        elementLifeLabels: {
            Wood: '成長と拡大',
            Fire: '勢いと注目',
            Earth: '安定と責任',
            Metal: '整理と洗練',
            Water: '柔軟さと深み'
        },
        colorWords: {
            Wood: '青',
            Fire: '赤',
            Earth: '黄',
            Metal: '白',
            Water: '黒'
        },
        animals: ['鼠', '牛', '虎', '兎', '龍', '蛇', '馬', '羊', '猿', '鶏', '犬', '猪'],
        stems: ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'],
        stemElements: ['Wood', 'Wood', 'Fire', 'Fire', 'Earth', 'Earth', 'Metal', 'Metal', 'Water', 'Water']
    },
    ko: {
        documentTitle: '일주 동물 확인',
        title: '당신의 일주 동물을 확인해보세요!',
        description: '생년월일을 입력하면 일주 동물과 오행의 기운을 알려드립니다.',
        brandName: 'Animal Energy',
        brandTagline: '글로벌 일주 인사이트 스튜디오',
        navOverview: '개요',
        navInsights: '인사이트',
        navPlans: '플랜',
        navSupport: '지원',
        loginButton: '로그인',
        signupButton: '회원가입',
        heroEyebrow: '프로페셔널 일주 서비스',
        heroPrimary: '진단 시작',
        heroSecondary: '플랜 보기',
        trustItem1: '20개국 이상 사용',
        trustItem2: '개인 대시보드 제공',
        trustItem3: '안전한 프로필 보관',
        cardTitle: '개인 맞춤 진단 시작',
        cardSubtitle: '일주 분석과 오행 밸런스를 결합해 명확한 결과를 제공합니다.',
        servicesEyebrow: '제공 서비스',
        servicesTitle: '정돈된 전문 경험',
        servicesSubtitle: '해외 사용자도 쉽게 이해할 수 있는 구조화된 인사이트.',
        serviceOneTitle: '일주 핵심 요약',
        serviceOneText: '동물, 기운, 키워드를 한 번에 정리합니다.',
        serviceTwoTitle: '개인 대시보드',
        serviceTwoText: '로그인 후 여러 프로필 저장과 비교가 가능합니다.',
        serviceThreeTitle: '전문가용 리포트',
        serviceThreeText: '상담 및 계획에 활용 가능한 요약 리포트를 제공합니다.',
        plansEyebrow: '멤버십',
        plansTitle: '글로벌 사용자용 플랜',
        plansSubtitle: '필요한 깊이에 맞춘 옵션을 선택하세요.',
        planStarterTitle: '스타터',
        planStarterText: '1회 진단과 요약 제공.',
        planStarterPrice: '$9',
        planStarterCta: '스타터 선택',
        planProTitle: '프로',
        planProText: '무제한 진단, 히스토리, 리포트 제공.',
        planProPrice: '$19 / 월',
        planProCta: '프로 선택',
        planPlusTitle: '플러스',
        planPlusText: '상담용 인사이트와 우선 지원.',
        planPlusPrice: '$39 / 월',
        planPlusCta: '플러스 선택',
        supportEyebrow: '지원',
        supportTitle: '명확한 가이드',
        supportSubtitle: '국제 사용자에게 필요한 설명과 가이드를 제공합니다.',
        supportOneTitle: '다국어 요약',
        supportOneText: '가족이나 친구와 공유하기 쉬운 표현.',
        supportTwoTitle: '안전한 프로필',
        supportTwoText: '로그인으로 결과를 안전하게 보관합니다.',
        footerBrand: 'Animal Energy',
        footerTagline: '글로벌 일주 인사이트 스튜디오',
        footerText: '현대적 의사결정에 맞춘 글로벌 ILJU 해석 서비스.',
        footerLinkOverview: '개요',
        footerLinkInsights: '인사이트',
        footerLinkPlans: '플랜',
        footerLinkSupport: '지원',
        langLabel: '언어',
        languageNames: {
            en: '영어',
            ja: '일본어',
            ko: '한국어'
        },
        labelYear: '생년',
        labelMonth: '월',
        labelDay: '일',
        labelTime: '태어난 시간(선택)',
        placeholderYear: '예: 1990',
        placeholderMonth: '예: 7',
        placeholderDay: '예: 14',
        placeholderTime: '예: 08:30',
        checkButton: '확인하기',
        detailButton: '더 알아보기',
        resultTitle: '당신의 일주 동물',
        resultAnimalLabel: '동물',
        resultElementLabel: '기운',
        resultKeywordsLabel: '키워드',
        resultSummaryTemplate: '기본 기질은 {animalTrait}. 관계에서는 {relationTip} 흐름, 일/학업에서는 {workTip} 흐름, 금전에서는 {moneyTip} 포인트가 두드러져요. 인생 흐름은 초년기 {earlyLife}, 중년기 {midLife}, 노년기 {lateLife} 쪽으로 나타나기 쉽습니다.',
        resetButton: '다른 날짜로 다시하기',
        invalidDate: '올바른 날짜를 입력해주세요.',
        invalidYear: '연도는 1900년부터 {maxYear}년까지 입력해주세요.',
        invalidMonth: '월은 1~12 사이로 입력해주세요.',
        invalidDay: '선택한 연/월에 맞는 일자를 입력해주세요.',
        animalSentence: '십이지신 중 {animal}입니다.',
        elementSentence: '{color} {animal}, {element}의 기운을 지닌 동물이에요.',
        elementNames: {
            Wood: '목',
            Fire: '화',
            Earth: '토',
            Metal: '금',
            Water: '수'
        },
        elementKeywords: {
            Wood: '성장 · 유연 · 따뜻',
            Fire: '열정 · 표현 · 에너지',
            Earth: '안정 · 균형 · 배려',
            Metal: '명확 · 절제 · 집중',
            Water: '직관 · 깊이 · 흐름'
        },
        animalTraits: {
            쥐: '눈치가 빠르고 정보에 강한 타입',
            소: '꾸준하고 믿음직한 타입',
            호랑이: '대담하고 추진력이 강한 타입',
            토끼: '온화하고 조율을 잘하는 타입',
            용: '존재감이 크고 도전적인 타입',
            뱀: '직관적이고 전략적인 타입',
            말: '에너지 넘치고 자유로운 타입',
            양: '따뜻하고 감성이 풍부한 타입',
            원숭이: '유연하고 아이디어가 많은 타입',
            닭: '분명하고 정리정돈이 좋은 타입',
            개: '성실하고 책임감이 강한 타입',
            돼지: '너그럽고 인간관계가 좋은 타입'
        },
        elementAdvice: {
            Wood: {
                relation: '천천히 신뢰를 쌓는',
                work: '단계적으로 확장하는',
                money: '장기 계획을 세우는'
            },
            Fire: {
                relation: '감정을 솔직히 표현하는',
                work: '속도를 살리되 과로를 피하는',
                money: '충동 지출을 줄이는'
            },
            Earth: {
                relation: '안정감을 주는',
                work: '꾸준함을 유지하는',
                money: '지출을 정리해 균형을 맞추는'
            },
            Metal: {
                relation: '선과 경계를 분명히 하는',
                work: '정확도와 구조를 다지는',
                money: '불필요한 새는 돈을 막는'
            },
            Water: {
                relation: '거리감을 조절하며 관찰하는',
                work: '한 가지에 깊게 파고드는',
                money: '유동자금을 확보하는'
            }
        },
        elementLife: {
            Wood: {
                early: '호기심과 성장 중심으로 기반을 다지는',
                mid: '꾸준함으로 확장되는',
                late: '장기 투자와 멘토링이 안정이 되는'
            },
            Fire: {
                early: '속도감 있는 도전이 많은',
                mid: '주목과 리더십이 늘어나는',
                late: '창의성을 살려 선택이 정교해지는'
            },
            Earth: {
                early: '책임을 맡으며 토대를 쌓는',
                mid: '신뢰와 평판이 누적되는',
                late: '인내의 결실로 안정되는'
            },
            Metal: {
                early: '기준이 분명하고 성장 속도가 빠른',
                mid: '전문성이 깊어져 신뢰가 쌓이는',
                late: '규율이 강점으로 굳어지는'
            },
            Water: {
                early: '관찰력으로 유연하게 배우는',
                mid: '전략적 전환이 빛을 보는',
                late: '차분한 안정과 지혜가 커지는'
            }
        },
        elementLifeLabels: {
            Wood: '성장과 확장',
            Fire: '속도와 주목',
            Earth: '안정과 책임',
            Metal: '정리와 정교함',
            Water: '유연함과 깊이'
        },
        colorWords: {
            Wood: '푸른',
            Fire: '붉은',
            Earth: '노란',
            Metal: '하얀',
            Water: '검은'
        },
        animals: ['쥐', '소', '호랑이', '토끼', '용', '뱀', '말', '양', '원숭이', '닭', '개', '돼지'],
        stems: ['갑', '을', '병', '정', '무', '기', '경', '신', '임', '계'],
        stemElements: ['Wood', 'Wood', 'Fire', 'Fire', 'Earth', 'Earth', 'Metal', 'Metal', 'Water', 'Water']
    }
};

const languageSelect = document.getElementById('languageSelect');
const langSwitcher = document.querySelector('.lang-switcher');
const yearInput = document.getElementById('year');
const monthInput = document.getElementById('month');
const dayInput = document.getElementById('day');
const timeInput = document.getElementById('birthTime');
const errorMessage = document.getElementById('errorMessage');
const checkButton = document.getElementById('checkButton');
const resetButton = document.getElementById('resetButton');
const resultImage = document.getElementById('resultImage');
const resultImageSlot = document.getElementById('resultImageSlot');
let currentLang = 'en';
let lastYear = null;

const urlLang = new URLSearchParams(window.location.search).get('lang');
const savedLang = sessionStorage.getItem('lang');
if (savedLang && i18n[savedLang]) {
    currentLang = savedLang;
}
if (urlLang && i18n[urlLang]) {
    currentLang = urlLang;
}
languageSelect.value = currentLang;

languageSelect.addEventListener('change', (event) => {
    currentLang = event.target.value;
    sessionStorage.setItem('lang', currentLang);
    applyLanguage(currentLang);
});

checkButton.addEventListener('click', () => {
    const validation = validateInputs();
    if (!validation.isValid) {
        renderValidation(validation);
        return;
    }

    lastYear = validation.year;
    const zodiac = getZodiac(validation.year, currentLang);
    updateResultContent(zodiac, currentLang);
    updateDetailLink(validation.year, currentLang);
    document.getElementById('result').classList.remove('hidden');
});

resetButton.addEventListener('click', () => {
    yearInput.value = '';
    monthInput.value = '';
    dayInput.value = '';
    lastYear = null;
    document.getElementById('result').classList.add('hidden');
    clearValidation();
    updateCheckButtonState();
});

function getCurrentYear() {
    return new Date().getFullYear();
}

function getDaysInMonth(year, month) {
    return new Date(year, month, 0).getDate();
}

function validateInputs() {
    const year = parseInt(yearInput.value, 10);
    const month = parseInt(monthInput.value, 10);
    const day = parseInt(dayInput.value, 10);
    const maxYear = getCurrentYear();

    if (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) {
        return { isValid: false, errorKey: 'invalidDate' };
    }

    if (year < 1900 || year > maxYear) {
        return { isValid: false, errorKey: 'invalidYear', meta: { maxYear } };
    }

    if (month < 1 || month > 12) {
        return { isValid: false, errorKey: 'invalidMonth' };
    }

    const maxDay = getDaysInMonth(year, month);
    if (day < 1 || day > maxDay) {
        return { isValid: false, errorKey: 'invalidDay' };
    }

    return { isValid: true, year, month, day };
}

function renderValidation(validation) {
    const copy = i18n[currentLang];
    const messageTemplate = copy[validation.errorKey] || copy.invalidDate;
    const message = messageTemplate.replace('{maxYear}', validation.meta?.maxYear ?? getCurrentYear());
    errorMessage.innerText = message;

    yearInput.classList.toggle('input-error', validation.errorKey === 'invalidYear' || validation.errorKey === 'invalidDate');
    monthInput.classList.toggle('input-error', validation.errorKey === 'invalidMonth' || validation.errorKey === 'invalidDate');
    dayInput.classList.toggle('input-error', validation.errorKey === 'invalidDay' || validation.errorKey === 'invalidDate');
}

function clearValidation() {
    errorMessage.innerText = '';
    yearInput.classList.remove('input-error');
    monthInput.classList.remove('input-error');
    dayInput.classList.remove('input-error');
}

function updateCheckButtonState() {
    const validation = validateInputs();
    checkButton.disabled = !validation.isValid;
    if (validation.isValid) {
        clearValidation();
    }
}

['input', 'blur'].forEach((eventName) => {
    yearInput.addEventListener(eventName, updateCheckButtonState);
    monthInput.addEventListener(eventName, updateCheckButtonState);
    dayInput.addEventListener(eventName, updateCheckButtonState);
});

function applyLanguage(lang) {
    const copy = i18n[lang];
    document.documentElement.lang = lang;
    document.title = copy.documentTitle;
    document.getElementById('brandName').innerText = copy.brandName;
    document.getElementById('brandTagline').innerText = copy.brandTagline;
    document.getElementById('navOverview').innerText = copy.navOverview;
    document.getElementById('navInsights').innerText = copy.navInsights;
    document.getElementById('navPlans').innerText = copy.navPlans;
    document.getElementById('navSupport').innerText = copy.navSupport;
    document.getElementById('loginButton').innerText = copy.loginButton;
    document.getElementById('signupButton').innerText = copy.signupButton;
    document.getElementById('heroEyebrow').innerText = copy.heroEyebrow;
    document.getElementById('heroPrimary').innerText = copy.heroPrimary;
    document.getElementById('heroSecondary').innerText = copy.heroSecondary;
    document.getElementById('trustItem1').innerText = copy.trustItem1;
    document.getElementById('trustItem2').innerText = copy.trustItem2;
    document.getElementById('trustItem3').innerText = copy.trustItem3;
    document.getElementById('cardTitle').innerText = copy.cardTitle;
    document.getElementById('cardSubtitle').innerText = copy.cardSubtitle;
    document.getElementById('servicesEyebrow').innerText = copy.servicesEyebrow;
    document.getElementById('servicesTitle').innerText = copy.servicesTitle;
    document.getElementById('servicesSubtitle').innerText = copy.servicesSubtitle;
    document.getElementById('serviceOneTitle').innerText = copy.serviceOneTitle;
    document.getElementById('serviceOneText').innerText = copy.serviceOneText;
    document.getElementById('serviceTwoTitle').innerText = copy.serviceTwoTitle;
    document.getElementById('serviceTwoText').innerText = copy.serviceTwoText;
    document.getElementById('serviceThreeTitle').innerText = copy.serviceThreeTitle;
    document.getElementById('serviceThreeText').innerText = copy.serviceThreeText;
    document.getElementById('plansEyebrow').innerText = copy.plansEyebrow;
    document.getElementById('plansTitle').innerText = copy.plansTitle;
    document.getElementById('plansSubtitle').innerText = copy.plansSubtitle;
    document.getElementById('planStarterTitle').innerText = copy.planStarterTitle;
    document.getElementById('planStarterText').innerText = copy.planStarterText;
    document.getElementById('planStarterPrice').innerText = copy.planStarterPrice;
    document.getElementById('planStarterCta').innerText = copy.planStarterCta;
    document.getElementById('planProTitle').innerText = copy.planProTitle;
    document.getElementById('planProText').innerText = copy.planProText;
    document.getElementById('planProPrice').innerText = copy.planProPrice;
    document.getElementById('planProCta').innerText = copy.planProCta;
    document.getElementById('planPlusTitle').innerText = copy.planPlusTitle;
    document.getElementById('planPlusText').innerText = copy.planPlusText;
    document.getElementById('planPlusPrice').innerText = copy.planPlusPrice;
    document.getElementById('planPlusCta').innerText = copy.planPlusCta;
    document.getElementById('supportEyebrow').innerText = copy.supportEyebrow;
    document.getElementById('supportTitle').innerText = copy.supportTitle;
    document.getElementById('supportSubtitle').innerText = copy.supportSubtitle;
    document.getElementById('supportOneTitle').innerText = copy.supportOneTitle;
    document.getElementById('supportOneText').innerText = copy.supportOneText;
    document.getElementById('supportTwoTitle').innerText = copy.supportTwoTitle;
    document.getElementById('supportTwoText').innerText = copy.supportTwoText;
    document.getElementById('footerBrand').innerText = copy.footerBrand;
    document.getElementById('footerTagline').innerText = copy.footerTagline;
    document.getElementById('footerText').innerText = copy.footerText;
    document.getElementById('footerLinkOverview').innerText = copy.footerLinkOverview;
    document.getElementById('footerLinkInsights').innerText = copy.footerLinkInsights;
    document.getElementById('footerLinkPlans').innerText = copy.footerLinkPlans;
    document.getElementById('footerLinkSupport').innerText = copy.footerLinkSupport;
    document.getElementById('title').innerText = copy.title;
    document.getElementById('description').innerText = copy.description;
    document.getElementById('langLabel').innerText = copy.langLabel;
    languageSelect.setAttribute('aria-label', copy.langLabel);
    languageSelect.options[0].text = copy.languageNames.en;
    languageSelect.options[1].text = copy.languageNames.ja;
    languageSelect.options[2].text = copy.languageNames.ko;
    document.getElementById('labelYear').innerText = copy.labelYear;
    document.getElementById('labelMonth').innerText = copy.labelMonth;
    document.getElementById('labelDay').innerText = copy.labelDay;
    document.getElementById('labelTime').innerText = copy.labelTime;
    document.getElementById('year').setAttribute('placeholder', copy.placeholderYear);
    document.getElementById('month').setAttribute('placeholder', copy.placeholderMonth);
    document.getElementById('day').setAttribute('placeholder', copy.placeholderDay);
    document.getElementById('birthTime').setAttribute('placeholder', copy.placeholderTime);
    document.getElementById('checkButton').innerText = copy.checkButton;
    document.getElementById('detailButton').innerText = copy.detailButton;
    document.getElementById('resultTitle').innerText = copy.resultTitle;
    document.getElementById('resultAnimalLabel').innerText = copy.resultAnimalLabel;
    document.getElementById('resultElementLabel').innerText = copy.resultElementLabel;
    document.getElementById('resultKeywordsLabel').innerText = copy.resultKeywordsLabel;
    document.getElementById('resetButton').innerText = copy.resetButton;
    resultImage.alt = copy.resultTitle;
    langSwitcher.setAttribute('data-lang', lang);

    if (lastYear !== null && !document.getElementById('result').classList.contains('hidden')) {
        const zodiac = getZodiac(lastYear, lang);
        updateResultContent(zodiac, lang);
        updateDetailLink(lastYear, lang);
    }

    updateCheckButtonState();
}

function getZodiac(year, lang) {
    const data = i18n[lang];
    const dayIndex = getDayPillarIndex(year, monthInput.value, dayInput.value);
    const stemIndex = dayIndex % 10;
    const branchIndex = dayIndex % 12;
    const animal = data.animals[branchIndex];
    const elementKey = data.stemElements[stemIndex];
    const element = data.elementNames[elementKey];
    const color = data.colorWords[elementKey];
    const yearIndex = getYearPillarIndex(year);
    const monthIndex = getMonthPillarIndex(year, monthInput.value);
    const timeIndex = getTimePillarIndex(dayIndex, timeInput?.value || '');
    const yearElementKey = data.stemElements[yearIndex % 10];
    const monthElementKey = data.stemElements[monthIndex % 10];
    const timeElementKey = timeIndex !== null ? data.stemElements[timeIndex % 10] : null;
    return {
        animal,
        element,
        color,
        elementKey,
        dayIndex,
        yearElementKey,
        monthElementKey,
        timeElementKey
    };
}

function updateResultContent(zodiac, lang) {
    const copy = i18n[lang];
    document.getElementById('animal').innerText = zodiac.animal;
    document.getElementById('element').innerText = zodiac.element;
    document.getElementById('keywords').innerText = copy.elementKeywords[zodiac.elementKey] || '';
    document.getElementById('resultSummary').innerText = buildResultSummary(zodiac, lang);
    setResultImage('');
}

function buildResultSummary(zodiac, lang) {
    const copy = i18n[lang];
    const template = copy.resultSummaryTemplate;
    if (!template) {
        return '';
    }

    const animalTrait = copy.animalTraits?.[zodiac.animal] || '';
    const advice = copy.elementAdvice?.[zodiac.elementKey] || {};
    const yearElement = zodiac.yearElementKey || zodiac.elementKey;
    const monthElement = zodiac.monthElementKey || zodiac.elementKey;
    const timeElement = zodiac.timeElementKey || zodiac.elementKey;
    const earlyLife = copy.elementLifeLabels?.[yearElement] || copy.elementLife?.[yearElement]?.early || '';
    const midLife = copy.elementLifeLabels?.[monthElement] || copy.elementLife?.[monthElement]?.mid || '';
    const lateLife = copy.elementLifeLabels?.[timeElement] || copy.elementLife?.[timeElement]?.late || '';
    return template
        .replace('{animalTrait}', animalTrait)
        .replace('{relationTip}', advice.relation || '')
        .replace('{workTip}', advice.work || '')
        .replace('{moneyTip}', advice.money || '')
        .replace('{earlyLife}', earlyLife)
        .replace('{midLife}', midLife)
        .replace('{lateLife}', lateLife);
}

function setResultImage(src) {
    if (!src) {
        resultImage.removeAttribute('src');
        resultImageSlot.classList.add('is-empty');
        return;
    }

    resultImage.src = src;
    resultImageSlot.classList.remove('is-empty');
}

function updateDetailLink(year, lang) {
    const detailButton = document.getElementById('detailButton');
    const dayIndex = getDayPillarIndex(year, monthInput.value, dayInput.value);
    const pageId = String(dayIndex + 1).padStart(2, '0');
    detailButton.href = `details/${pageId}.html?lang=${lang}`;
}

function getDayPillarIndex(yearValue, monthValue, dayValue) {
    const year = parseInt(yearValue, 10);
    const month = parseInt(monthValue, 10);
    const day = parseInt(dayValue, 10);
    const anchorUTC = Date.UTC(1900, 0, 31);
    const targetUTC = Date.UTC(year, month - 1, day);
    const daysSince = Math.floor((targetUTC - anchorUTC) / 86400000);
    const anchorIndex = 40;
    return ((daysSince + anchorIndex) % 60 + 60) % 60;
}

function getYearPillarIndex(yearValue) {
    const year = parseInt(yearValue, 10);
    const anchorYear = 1984;
    const anchorIndex = 0;
    return ((year - anchorYear + anchorIndex) % 60 + 60) % 60;
}

function getMonthPillarIndex(yearValue, monthValue) {
    const yearIndex = getYearPillarIndex(yearValue);
    const month = parseInt(monthValue, 10);
    if (Number.isNaN(month)) {
        return yearIndex;
    }
    return ((yearIndex % 10) * 12 + (month - 1)) % 60;
}

function getTimePillarIndex(dayIndex, timeValue) {
    if (!timeValue) {
        return null;
    }
    const [hourString] = timeValue.split(':');
    const hour = parseInt(hourString, 10);
    if (Number.isNaN(hour)) {
        return null;
    }
    const branchIndex = Math.floor(((hour + 1) % 24) / 2);
    return ((dayIndex % 10) * 12 + branchIndex) % 60;
}

applyLanguage(currentLang);
